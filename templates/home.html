<!doctype html>
<html lang="en">
    <head>
        <title>Librarian for Spotify</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style_home.css') }}" />
        <!-- <script src="{{ url_for('static',filename='js/getsongs.js')}}"></script> -->
    </head>
    <body>
        <div id="content">
            <header>Librarian for Spotify</header>
            <div id="songs">
                <h1></h1>
                
            </div>
            <div id="playlist-options">
                
            </div>
        </div>



        <!-- JS script -->
        <script>
            document.getElementById('content').className = 'loading';
            let auth = 'Bearer ' + '{{token}}' ;
            let header = {Authorization: auth};
            let track_data = [];
            let audio_data = [];
            let is_next = true;
            let offset = 0;

            while (is_next && offset < 500) {
                fetch('https://api.spotify.com/v1/me/tracks?limit=50&offset='+offset,{headers:header}).then(res => res.json()).then(response => {
                    if (response.next == null) {
                        is_next = false;
                    };
                    return response.items;
                }).then(tracks => {
                    if (offset == 0) {console.log(tracks)};
                    let ids = tracks.map(x => x.track.id);
                    let query_url = 'https://api.spotify.com/v1/audio-features?ids=' + ids.toString();
                    let audio_features = fetch(query_url,{headers:header}).then(res => res.json()).then(response => response.audio_features).then(audio_features => {

                    track_data = track_data.concat(tracks);
                    audio_data = audio_data.concat(audio_features);
                    });
                });
                offset += 50;
                if (offset % 500 == 0) {
                    console.log('pulled ' + offset + ' songs, sleeping')
                    setTimeout(() => {},3000)
                    console.log('awake')
                }
            };

            console.log(track_data);
            console.log(audio_data);

            let user_tracks = track_data.map((track,i) => ({
                    'explicit': track.track.explicit,
                    'track_popularity': track.track.popularity,
                    'artist_genres': track.track.artists[0].genres,
                    'artist_popularity':track.track.artists[0].popularity,
                    'release_date': track.track.album.release_date,
                    'album_genres': track.track.album.genres,
                    'album_popularity': track.track.album.popularity,

                    'acousticness': audio_data[i].acousticness,
                    'danceability': audio_data[i].danceability,
                    'duration': audio_data[i].duration_ms,
                    'energy': audio_data[i].energy,
                    'instrumentalness': audio_data[i].instrumentalness,
                    'key': audio_data[i].key,
                    'liveness': audio_data[i].liveness,
                    'loudness': audio_data[i].loudness,
                    'mode': audio_data[i].mode,
                    'speechiness': audio_data[i].speechiness,
                    'tempo': audio_data[i].tempo,
                    'time_signature': audio_data[i].time_signature,
                    'valence': audio_data[i].valence
                }));

            console.log(user_tracks)
            localStorage.setItem("tracks",user_tracks);
                

        </script>
    </body>
</html>
